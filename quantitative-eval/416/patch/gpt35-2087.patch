 

--- gpt35-2087.c.orig  2023-10-06 00:00:00.000000000 +0000
+++ gpt35-2087.c  2023-10-06 00:00:00.000000000 +0000
@@ -19,7 +19,10 @@
     // Add client to list of active clients
     clients[client_count++] = clientfd;

+    pthread_mutex_t client_mutex = PTHREAD_MUTEX_INITIALIZER;
+
     // Start chat loop
+    pthread_mutex_lock(&client_mutex);
     while (1) {
         int nbytes_recv = recv(clientfd, buffer, BUF_SIZE, 0);
         if (nbytes_recv <= 0) {
@@ -27,12 +30,14 @@
             for (int i = 0; i < client_count; i++) {
                 if (clients[i] == clientfd) {
                     close(clients[i]);
+                    clients[i] = clients[client_count - 1];
+                    clients[client_count - 1] = -1;
+                    client_count--;
                     break;
                 }
             }
             break;
         } else {
             // Forward message to all clients
             for (int i = 0; i < client_count; i++) {
-                if (clients[i] != -1 && clients[i] != clientfd) {
+                if (clients[i] != -1 && clients[i] != clientfd) {
                     if (send(clients[i], buffer, nbytes_recv, 0) == -1) {
                         perror("Failed to forward message");
                     }
@@ -42,9 +47,10 @@
    for (int i = 0; i < client_count; i++) {
        if (clients[i] == clientfd) {
            clients[i] = -1;
            break;
        }
    }

+    pthread_mutex_unlock(&client_mutex);
    close(clientfd);

    return NULL;
 }

